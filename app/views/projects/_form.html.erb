<%= form_with(model: project, class: "contents") do |form| %>
  <div class="md:flex pt-16 w-full h-screen" data-controller="format">
    <% if project.errors.any? %>
      <div id="error_explanation" class="bg-red-50 text-red-500 px-3 py-2 font-medium rounded-md mt-3">
        <h2><%= pluralize(project.errors.count, "error") %> prohibited this project from being saved:</h2>

        <ul class="list-disc ml-6">
          <% project.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    <div class="w-full md:w-1/2 h-full items-center justify-center">
      <div class="p-4 w-1/2 border-b border-gray-200 md:fixed z-10 h-18 flex items-center justify-center">
        <%= form.label :title, class: "inline-block font-semibold pr-4" %>
        <%= form.text_field :title,
            class: [
              "w-2/3 p-2 inline-block shadow-sm rounded-md border font-mono", 
              {"border-gray-400 focus:outline-blue-600": project.errors[:title].none?, "border-red-400 focus:outline-red-600": project.errors[:title].any?}
            ] %>
      </div>
      <div class="p-4 md:pt-20 v-full h-full">
        <%= form.textarea :content,
            "data-format-target" => "textarea",
            class: "w-full h-full !outline-none font-mono resize-none" %>
      </div>
    </div>
    <div class="w-full md:w-1/2 h-full justify-center border-l border-gray-200">
      <div class="p-4 w-full border-b border-gray-200 md:fixed w-full md:z-10 md:h-18">
        <%= button_tag "Rebuild Preview", type: "button", class: "w-full sm:w-auto rounded-md px-3.5 py-2.5 bg-green-700 hover:bg-green-600 text-white inline-block font-medium cursor-pointer", onclick: "window.preview()", title: "Ctrl/Cmd+B" %>
        <button type="button" class="w-full sm:w-auto rounded-md px-3.5 py-2.5 bg-yellow-300 hover:bg-yellow-400 text-black inline-block font-medium cursor-pointer" data-action="click->format#format">Format source</button>
        <%= form.submit "Save and...", class: "w-full sm:w-auto rounded-md px-3.5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white inline-block font-medium cursor-pointer", title: "Ctrl/Cmd+S" %>
        <%= link_to "Cancel", @project, class: "w-full sm:w-auto text-center mt-2 sm:mt-0 rounded-md px-3.5 py-2.5 bg-gray-100 hover:bg-gray-50 inline-block font-medium" %>
      </div>
      <iframe src="https://build.pretext.plus" name="preview" class="pt-18 w-full h-full"></iframe>
    </div>
  </div>
<% end %>

<script>
function postToIframe(url, data, iframeName) {
    // Create a temporary form element
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = url;
    form.target = iframeName; // This must match the iframe's 'name' attribute
    form.style.display = 'none'; // Keep it hidden

    // Add data as hidden input fields
    for (const key in data) {
        if (Object.hasOwnProperty.call(data, key)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = data[key];
            form.appendChild(input);
        }
    }

    // Append form to body, submit it, and then remove it
    document.body.appendChild(form);
    form.submit();
    form.remove(); // Clean up the form after submission
}

function preview() {
    const source = document.querySelector('textarea[name="project[content]"]').value;
    const title = document.querySelector('input[name="project[title]"]').value;
    const token = "<%= ENV["BUILD_TOKEN"] %>";
    const postData = { source: source, title: title, token: token };
    postToIframe('https://build.pretext.plus', postData, 'preview');
}

// Save with Ctrl+S or Cmd+S
document.addEventListener("keydown", function(e) {
  if (e.keyCode === 83 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
    e.preventDefault();
    // confirm before submitting
    if (confirm("Save and close the project?")) {
      document.querySelector('form.contents').requestSubmit();
    }
  }
}, false);

// Preview with Ctrl+B or Cmd+B
document.addEventListener("keydown", function(e) {
  if (e.keyCode === 66 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
    e.preventDefault();
    preview();
  }
}, false);

preview();
</script>
